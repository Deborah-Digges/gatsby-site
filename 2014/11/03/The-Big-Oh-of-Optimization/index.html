<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.a958a4287dc123cfa21f.css">*{box-sizing:border-box}body,html{margin:0;padding:0}html{font-family:Helvetica Neue,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5}@media (min-width:38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:focus,a:hover{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:700;line-height:1.25;text-rendering:optimizeLegibility}h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}dl,ol,ul{margin-top:0;margin-bottom:1rem}dt{font-weight:700}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:700;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo,Monaco,Courier New,monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;border-radius:3px}code,pre{background-color:#f9f9f9}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo,Monaco,Courier New,monospace!important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem!important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media (min-width:30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 0 1rem;border-radius:5px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}body,html{overflow-x:hidden}html{font-family:"PT Serif",Georgia,Times New Roman,serif}h1,h2,h3,h4,h5,h6{font-family:Calendas_Plus,Helvetica,Arial,sans-serif;font-weight:400;color:#313131;letter-spacing:-.025rem}.wrap{position:relative;width:100%}.container{max-width:28rem}@media (min-width:38em){.container{max-width:32rem}}@media (min-width:56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-container{margin-right:1rem;margin-left:1rem;display:flex;justify-content:space-between;align-items:center}.masthead-nav{display:flex}.masthead-nav h4{margin-left:2em}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:silver;letter-spacing:0}@media (max-width:48em){.masthead-title{text-align:center}}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}img{clear:both;margin:0 auto}.align-center{text-align:center}.disclaimer-header{background-color:#bd6666;padding:2%;margin:5%;color:#fff;border-radius:5px;-webkit-border-radius:5px;-moz-border-radius:5px}@font-face{font-family:Calendas_Plus;src:url(/static/Calendas_Plus-4988e3b187a55c809d2358cfa8e2d340.otf) format("opentype")}</style><meta name="generator" content="Gatsby 2.24.53"/><link as="script" rel="preload" href="/webpack-runtime-c4214cb327f2e6d8ac3f.js"/><link as="script" rel="preload" href="/styles-1211262dd08146354a2f.js"/><link as="script" rel="preload" href="/framework-8c8d363c63d1a9a80d21.js"/><link as="script" rel="preload" href="/app-066ba96331d18d279169.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-2a78e23ce79482fd97dd.js"/><link as="fetch" rel="preload" href="/page-data/2014/11/03/The-Big-Oh-of-Optimization/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><body class="theme-base-13 sidebar-overlay"><div class="wrap"><div class="masthead"><div class="masthead-container"><h1 class="masthead-title"><a title="Home" href="/">Deb&#x27;s</a> <small>Doodles</small></h1><div class="masthead-nav"><h2 class="masthead-title"><a href="/about">About</a></h2></div></div></div><div class="container content"><div class="post"><h1 class="post-title">The Big Oh of Optimization</h1><span class="post-date">2014-11-03</span><div><p>We now have a functional GC, but we need to ask ourselves the question-<em>Can we do better?</em> This is a toy implementation, but if we look at something <a href="https://github.com/Deborah-Digges/mark-sweep-simulation/tree/master/04-Demo-GC-Pauses">real</a>, we find that the invocation of a mark-sweep GC causes pauses in the execution of the actual program, especially for programs which show a high memory utilization. When memory hits a low, the GC is invoked, and there are <em>noticable</em> pauses. Of course, we wouldn’t want these pauses to be too long so we need to figure out <em>where</em> we can do better.</p>
<h2>What to Optimize</h2>
<p>A good way to identify bottlenecks is by using a profiling tool like <em>gprof</em>. We add a <em>new test</em> for performance, where we initialize a heap of a 100,000 blocks and a threshold GC invocation of 1,000 blocks. The profiling shows the following results.
<img src="../images/gprof.png" alt="GPROF"></p>
<div class="align-center">Fig: Gprof Profile</div>
<p>A lot of the execution time is spent in the standard library functions and in the core GC routines - mark &#x26; sweep. We now know what to optimize.</p>
<h2>Optimizing the Mark Routine</h2>
<p>Revisiting the mark routine, we see that it is recursive. There is a significant time and space cost associated with such a recursive function because of the slowness of function calls and returns, and the overhead of managing the stack.
However, what recursion <em>is</em> great for is <em>understanding</em> the problem. </p>
<blockquote>
<p>“Loops may achieve a performance gain for your program. Recursion may achieve a performance gain for your programmer”.</p>
</blockquote>
<p>The algorithm is succinct and lends itself to easy interpretation -
Mark an object if it isn't already marked; if it has references to other objects, mark those too.</p>
<pre><code class="language-c++">void VM::mark(Object* object)
{
        if(object->marked)
        {
                return;
        }

        object->marked = 1;

        if(object->type == OBJ_PAIR)
        {
                mark(object->left);
                mark(object->right);
        }
}
</code></pre>
<h2>Implementing Mark using an Explicit Stack</h2>
<p>The mark routine can be <a href="https://github.com/Deborah-Digges/mark-sweep-simulation/tree/master/02-marksweep-Explicit-Stack">implemented iteratively</a>. We use an explicit stack for traversing allocated objects. It <em>does</em> the same thing, although <a href="https://github.com/Deborah-Digges/mark-sweep-simulation/blob/master/02-marksweep-Explicit-Stack/vm.cpp/#L151-192">the code</a> is more contorted and unnatural.<br/>
As we traverse a node, it is marked; it is pushed onto the stack if there are other nodes reachable from it--if it is not an atom. The algorithm repeateadly pops elements from the stack, marks the elements reachable from the popped element and performs the same procedure till the stack becomes empty.<br/></p>
<p><img src="../images/traversal.png" alt="GPROF"></p>
<div class="align-center">Fig: Mark Using an Explicit Stack</div>
<p>So, we've managed to convert the recursive algorithm into an iterative one, with some loss of elegance in the program code and some gain in speed.</p>
<h2>Premature Optimization is the Root of All Evil</h2>
<p>It’s a good idea to get a good grasp of the problem you’re trying to solve before trying to solve it better. Recursion helped us with just this--we <em>understood</em> what we were trying to do and <em>then</em> tried improving it.</p>
<p>While this code does improve our algorithm’s time, there is still the question of space. The size of the stack used for traversal grows linearly with the number of objects being traversed.</p>
<p>We ask ourselves the golden question-<em>can we do better?</em></p></div></div></div></div></body></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2014/11/03/The-Big-Oh-of-Optimization/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-1841db332360a105faeb.js"],"app":["/app-066ba96331d18d279169.js"],"component---src-pages-index-js":["/component---src-pages-index-js-741ba3c07f2717a9cf69.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-2a78e23ce79482fd97dd.js"]};/*]]>*/</script><script src="/polyfill-1841db332360a105faeb.js" nomodule=""></script><script src="/component---src-templates-blog-template-js-2a78e23ce79482fd97dd.js" async=""></script><script src="/app-066ba96331d18d279169.js" async=""></script><script src="/framework-8c8d363c63d1a9a80d21.js" async=""></script><script src="/styles-1211262dd08146354a2f.js" async=""></script><script src="/webpack-runtime-c4214cb327f2e6d8ac3f.js" async=""></script></body></html>